name: Notebook Tests

on:
  push:
    branches: [main]
    paths:
      - 'notebooks/**'
      - 'scripts/validate_notebooks.py'
      - '.github/workflows/notebook-tests.yml'
  pull_request:
    branches: [main]
    paths:
      - 'notebooks/**'
  workflow_dispatch:  # Allow manual triggering

jobs:
  validate-structure:
    name: Validate Notebook Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Validate notebook JSON structure
        run: |
          echo "NexVigilant Notebook Structure Validation"
          echo "========================================="
          python scripts/validate_notebooks.py --verbose

  execute-notebooks:
    name: Execute Notebooks
    runs-on: ubuntu-latest
    needs: validate-structure

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install nbconvert ipykernel

      - name: Install Python kernel
        run: python -m ipykernel install --user --name python3

      - name: Execute notebooks with validation
        run: |
          echo "NexVigilant Notebook Execution Tests"
          echo "===================================="
          python scripts/validate_notebooks.py --execute --timeout 180 --verbose

      - name: Upload executed notebooks (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failed-notebooks
          path: notebooks/*.ipynb
          retention-days: 7

  check-dependencies:
    name: Check Notebook Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check imports in notebooks
        run: |
          echo "Checking notebook imports..."
          python -c "
          import json
          import re
          from pathlib import Path

          required_packages = set()
          notebooks = list(Path('notebooks').glob('*.ipynb'))

          for nb_path in notebooks:
              with open(nb_path) as f:
                  nb = json.load(f)

              for cell in nb.get('cells', []):
                  if cell.get('cell_type') == 'code':
                      source = ''.join(cell.get('source', []))
                      # Find import statements
                      imports = re.findall(r'^import (\w+)', source, re.MULTILINE)
                      imports += re.findall(r'^from (\w+)', source, re.MULTILINE)
                      required_packages.update(imports)

          print('Packages imported in notebooks:')
          for pkg in sorted(required_packages):
              print(f'  - {pkg}')

          # Check against requirements.txt
          with open('requirements.txt') as f:
              requirements = f.read()

          missing = []
          # Map common package names to their pip package
          package_map = {
              'numpy': 'numpy',
              'pandas': 'pandas',
              'scipy': 'scipy',
              'matplotlib': 'matplotlib',
          }

          for pkg in ['numpy', 'pandas', 'scipy', 'matplotlib']:
              if pkg in required_packages and package_map.get(pkg, pkg).lower() not in requirements.lower():
                  missing.append(pkg)

          if missing:
              print(f'\\nMissing in requirements.txt: {missing}')
              exit(1)
          else:
              print('\\nâœ… All required packages found in requirements.txt')
          "
